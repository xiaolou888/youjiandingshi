# 数据库初始化说明

## 📋 方法一：使用一键初始化脚本（推荐）

这是最简单的方式，会一次性创建所有表结构和初始数据。

### 步骤：

1. **确保已安装依赖**
```bash
cd server
npm install
```

2. **配置数据库连接**

编辑 `server/.env` 文件：
```env
DB_HOST=localhost
DB_USER=youjiandingshi
DB_PASSWORD=your_password
DB_NAME=youjiandingshi
DB_PORT=3306
```

3. **执行初始化**
```bash
node import-complete-db.js
```

### 初始化内容：

✅ **创建的表：**
- `notifications` - 通知任务表（包含所有功能字段）
- `smtp_config` - SMTP配置表
- `send_logs` - 发送日志表（支持重复发送记录）
- `users` - 用户表
- `contacts` - 联系人表
- `contact_groups` - 联系人分组表

✅ **默认账号：**
- 用户名：`admin`
- 密码：`admin123`

---

## 📋 方法二：分步执行SQL文件

如果你想手动控制或使用数据库管理工具，可以按顺序执行以下SQL文件：

### 执行顺序：

1. `server/config/init-complete.sql` - 完整初始化（包含所有表和字段）

**或者分步执行：**

1. `server/config/init.sql` - 基础表结构
2. `server/config/add-auth-tables.sql` - 用户认证
3. `server/config/add-contacts-table.sql` - 收件人管理
4. `server/config/add-custom-period.sql` - 自定义周期
5. `server/config/add-repeat-sending.sql` - 重复发送
6. `server/config/add-quarterly.sql` - 每季度功能

---

## 📋 方法三：使用宝塔面板

1. 登录宝塔面板
2. 进入"数据库"
3. 找到你的数据库 `youjiandingshi`
4. 点击"导入"
5. 上传并执行 `server/config/init-complete.sql`

---

## 🔍 验证初始化是否成功

执行以下命令查看表结构：

```bash
cd server
node -e "const mysql = require('mysql2/promise'); require('dotenv').config(); (async () => { const conn = await mysql.createConnection({ host: process.env.DB_HOST, user: process.env.DB_USER, password: process.env.DB_PASSWORD, database: process.env.DB_NAME, port: process.env.DB_PORT }); const [tables] = await conn.query('SHOW TABLES'); console.log('📋 数据库表：'); tables.forEach(t => console.log('  ✓', Object.values(t)[0])); await conn.end(); })();"
```

应该看到 6 个表：
- notifications
- smtp_config
- send_logs
- users
- contacts
- contact_groups

---

## ⚠️ 注意事项

1. **数据库必须已存在**：初始化脚本不会创建数据库，只会创建表
2. **备份现有数据**：如果数据库中已有数据，请先备份
3. **权限要求**：数据库用户需要有 CREATE、ALTER、INSERT 权限
4. **字符集**：建议数据库使用 utf8mb4 字符集

---

## 🆘 常见问题

### Q: 提示"数据库不存在"
**A:** 需要先在宝塔面板或命令行创建数据库：
```sql
CREATE DATABASE youjiandingshi CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### Q: 提示"权限不足"
**A:** 确保数据库用户有足够权限：
```sql
GRANT ALL PRIVILEGES ON youjiandingshi.* TO 'youjiandingshi'@'%';
FLUSH PRIVILEGES;
```

### Q: 想重新初始化
**A:** 删除所有表后重新执行：
```sql
DROP TABLE IF EXISTS notifications, smtp_config, send_logs, users, contacts, contact_groups;
```
然后重新执行 `node import-complete-db.js`

---

## 📞 技术支持

如遇到问题，请检查：
1. `.env` 文件配置是否正确
2. 数据库服务是否正常运行
3. 网络连接是否正常
4. 数据库用户权限是否充足

