# 📦 消息通知系统 - 宝塔面板详细安装教程

> 适用于 CentOS 7 + 宝塔面板 + Nginx 环境
> 本教程采用图形化操作，无需命令行

---

## 📋 前置准备

### ⚠️ CentOS 7 用户特别注意

**如果您使用的是 CentOS 7 系统，请先阅读：**

CentOS 7 **不支持 Node.js 18+**，宝塔会提示：`操作系统版本过低，该Node版本不兼容此操作系统`

**解决方案**：
1. **推荐**：查看 `CentOS7兼容性说明.md`，使用降级方案（使用 Node.js 16 + Vite 4）
2. 或升级到 Rocky Linux 8 / Ubuntu 22.04

---

### 1. 确认宝塔环境

**标准配置（非 CentOS 7）：**
- ✅ **Nginx** (任意版本)
- ✅ **MySQL 5.7+** (推荐 5.7 或 8.0)
- ✅ **Node.js 18.x 或 20.x** ⚠️ **必须 18 或更高版本！**

**CentOS 7 配置：**
- ✅ **Nginx** (任意版本)
- ✅ **MySQL 5.7+** (推荐 5.7 或 8.0)
- ✅ **Node.js 16.x** ⚠️ **CentOS 7 只能用 16.x**
- ⚠️ 需要修改前端配置（降级 Vite）

### 2. 安装 Node.js（重要）

#### 2.1 检查是否已安装
1. 登录宝塔面板
2. 点击左侧菜单 **"软件商店"**
3. 搜索 **"Node 版本管理器"** 或 **"Node.js"**

#### 2.2 安装 Node.js 18 或 20
1. 找到 **Node 版本管理器**，点击 **"设置"**
2. 在版本列表中，点击安装：
   - ✅ **Node.js 18.x**（推荐）
   - ✅ **Node.js 20.x**（也可以）
   - ❌ **Node.js 16.x**（版本太低，不支持）
3. 等待安装完成（约 1-2 分钟）

> ⚠️ **重要**：
> - 本项目使用 Vite 5，**必须使用 Node.js 18 或更高版本**
> - Node.js 16 会报错：`Unsupported engine`
> - 如果已经安装了 Node.js 16，请额外安装 Node.js 18

### 3. 确认其他软件
- 确认 **Nginx** 和 **MySQL** 已安装并运行

> 💡 **提示**：宝塔的 Node 项目管理功能会自动使用 PM2 管理进程，无需单独安装 PM2 管理器。

---

## 💡 重要提示 - 全新安装体验！

**🎉 本项目已升级为完全图形化安装！**

像 WordPress 一样，**所有配置都在浏览器中完成**：
- ✅ 无需手动创建 `.env` 文件
- ✅ 无需手动编辑配置
- ✅ 在安装向导中填写数据库信息即可
- ✅ 系统自动生成配置并重启

**安装流程简化为：**
1. 上传文件 → 2. 创建数据库 → 3. 启动服务 → 4. 访问网站 → 5. 填写配置 → 完成！

---

## ⚠️ 给小白用户的重要说明

### 关于目录名

本教程中使用 `notification` 作为示例目录名，但**你可以使用任何名称**！

**示例：**
- 如果你创建的目录叫 `tongzhi`，那么：
  - ❌ 错误：`/www/wwwroot/notification/server`
  - ✅ 正确：`/www/wwwroot/tongzhi/server`

- 如果你创建的目录叫 `youjiandingshi`，那么：
  - ❌ 错误：`cd /www/wwwroot/notification/client`
  - ✅ 正确：`cd /www/wwwroot/youjiandingshi/client`

**请在阅读教程时，将所有 `notification` 替换为你实际创建的目录名！**

### 关于宝塔终端

- ✅ **使用宝塔终端**（面板左侧菜单 → 终端）
- ❌ **不要使用 SSH 工具**（PuTTY、Xshell 等）

原因：宝塔终端已经配置好 Node.js 环境，可以直接使用 `npm` 命令。

---

## 🚀 详细安装步骤

### 第一步：上传项目文件

#### 1.1 创建网站目录
1. 宝塔面板 → **文件** → 进入 `/www/wwwroot/`
2. 点击 **"新建目录"**，命名为你想要的名称，例如：
   - `notification` （通知系统）
   - `tongzhi` （通知）
   - `youjiandingshi` （邮件定时）
   - 或其他你喜欢的名称
3. 进入刚创建的目录

> 💡 **重要提示**：
> - 目录名可以自定义，但建议使用英文或拼音
> - 本教程后续示例使用 `notification` 作为目录名
> - **请将后续所有 `notification` 替换为你实际创建的目录名**

#### 1.2 上传项目文件
**方式一：使用宝塔文件管理器**
1. 在 `/www/wwwroot/你的目录名/` 目录下
2. 点击 **"上传"** 按钮
3. 选择本地的 `youjiandingshi.zip` 文件
4. 等待上传完成后，右键点击压缩包 → **"解压"**
5. 解压后应该看到 `client`、`server`、`README.md` 等文件

**方式二：使用FTP工具**
1. 使用 FileZilla 等FTP工具连接服务器
2. 上传整个项目文件夹到 `/www/wwwroot/你的目录名/`

#### 1.3 确认目录结构
最终目录结构应该是（假设你的目录名是 `notification`）：
```
/www/wwwroot/notification/          ← 你创建的目录名
├── client/                         # 前端代码
├── server/                         # 后端代码
├── README.md
├── nginx.conf
└── 其他文件...
```

> ⚠️ **注意**：
> - 如果你创建的目录名是 `tongzhi`，那么路径就是 `/www/wwwroot/tongzhi/`
> - 后续所有命令中的 `notification` 都要改为你的目录名
> - 例如：`cd /www/wwwroot/notification/client` 改为 `cd /www/wwwroot/tongzhi/client`

---

### 第二步：创建MySQL数据库

#### 2.1 创建空数据库（只需创建，不用导入SQL）
1. 宝塔面板 → **数据库** → 点击 **"添加数据库"**
2. 填写数据库信息：
   - **数据库名**：`notification_system`（或自定义）
   - **用户名**：`notification_user`（或自定义）
   - **密码**：点击"生成"或自定义强密码
   - **访问权限**：选择 **"本地服务器"**
3. 点击 **"提交"**
4. **重要**：记录下数据库名、用户名、密码，后面要用

#### 2.2 初始化数据库（两种方式任选其一）

**方式一：使用安装向导自动初始化（推荐）⭐**
- 暂时跳过手动导入SQL
- 直接进行后续步骤
- 首次访问网站时，安装向导会引导您完成数据库初始化
- 只需在浏览器中点击几下即可完成

**方式二：手动导入SQL文件**
1. 在数据库列表中，找到刚创建的 `notification_system`
2. 点击右侧的 **"管理"** 按钮（或 phpMyAdmin）
3. 进入 **"导入"** 选项卡
4. 点击 **"选择文件"**
5. 选择项目中的 `server/config/init-complete.sql` 文件
6. 点击 **"执行"** 完成导入
7. 确认导入成功，应该看到多个数据表（users、notifications、contacts等）

> 💡 **建议**：如果您不熟悉数据库操作，推荐使用方式一，让安装向导帮您完成！

---

### 第三步：添加 Node 项目 🚀

> **✅ 无需手动配置 .env 文件！**
> 
> 新版本已支持在安装向导中自动生成配置，像 WordPress 一样简单！

#### 3.1 使用宝塔 Node 项目管理

1. 宝塔面板 → 左侧菜单 → **网站**
2. 点击顶部选项卡 → **Node 项目**
3. 点击 **"添加 Node 项目"** 按钮
4. 填写项目信息：

   **基本设置：**
   - **项目名称**：`消息通知系统`（自定义，随便填）
   - **项目目录**：`/www/wwwroot/你的目录名/server`
     - 例如：`/www/wwwroot/notification/server`
     - 或：`/www/wwwroot/tongzhi/server`
   - **启动文件**：`index.js`
   - **端口**：`3000`
   
   **高级设置：**
   - **Node 版本**：⚠️ **必须选择 18.x 或 20.x**（不要选 16.x）
   - **包管理器**：选择 `npm` 或 `pnpm`
   - **启动方式**：`npm`
   - **运行参数**：`start`（或留空，使用默认）
   - **项目域名**：留空（稍后配置 Nginx）
   
   **重要选项：**
   - ☑️ **请选择项目包管理器** - 勾选
   - ☐ **不安装node_module** - ⚠️ **不要勾选！**

5. 点击 **"提交"**

> ⚠️ **重要提示**：
> - **不要勾选"不安装node_module"选项**
> - 即使您已经上传了 `node_modules` 文件夹，也建议让宝塔重新安装
> - 原因：本地（Windows）和服务器（Linux）系统不同，某些依赖包（如 bcrypt）包含原生模块，需要在服务器上重新编译
> - 让宝塔自动安装可以避免跨平台兼容性问题
> - 安装过程需要 2-5 分钟，请耐心等待
6. 宝塔会自动：
   - 安装项目依赖（npm install）
   - 使用 PM2 启动项目
   - 配置开机自启

7. 等待 1-2 分钟，项目状态应该显示 **"正在运行"**

#### 3.2 验证后端运行（安装模式）

1. 在 Node 项目列表中，找到刚添加的项目
2. 点击右侧的 **"日志"** 按钮
3. 查看运行日志，应该看到：

```
╔════════════════════════════════════════════╗
║     ⚙️  消息通知系统 - 安装模式            ║
║     端口: 3000                             ║
║     请访问前端页面完成安装配置             ║
╚════════════════════════════════════════════╝
```

4. 看到这个提示说明后端已正常启动，等待配置

> 💡 **说明**：
> - 首次启动时，由于没有 `.env` 文件，后端会进入"安装模式"
> - 在安装模式下，只有安装相关的接口可用
> - 完成安装向导后，系统会自动重启并进入正常模式
> - 宝塔的 Node 项目管理会自动使用 PM2 管理进程，无需额外配置

#### 3.3 Node 项目管理的优势

✅ **图形化界面** - 无需命令行操作
✅ **自动安装依赖** - 自动执行 npm install
✅ **自动重启** - 代码更新或崩溃后自动重启
✅ **日志查看** - 方便查看运行日志和错误信息
✅ **开机自启** - 服务器重启后自动启动项目
✅ **资源监控** - 实时查看 CPU、内存使用情况

---

### 第四步：构建前端项目

#### 4.1 安装前端依赖并构建

**方法一：在文件管理器中打开终端（最简单）⭐ 推荐**

1. 宝塔面板 → 左侧菜单 → **文件**
2. 导航到 `/www/wwwroot/你的目录名/client/` 目录
   - 例如：`/www/wwwroot/tongzhi/client/`
3. 在 `client` 目录中，点击顶部工具栏的 **"终端"** 按钮
   - 📍 位置：在"上传"、"新建"等按钮旁边
4. 会自动打开终端，并且**已经在当前目录**了
5. 直接输入以下命令：

```bash
# 安装依赖
npm install

# 构建项目
npm run build
```

6. 等待构建完成（约2-5分钟）

> 💡 **这个方法的优势**：
> - ✅ 不需要手动 `cd` 切换目录
> - ✅ 自动在正确的路径打开
> - ✅ 更直观，不容易出错
> - ✅ 适合小白用户

---

**方法二：使用左侧菜单的终端**

如果找不到文件管理器的终端按钮，也可以：

1. 宝塔面板 → 左侧菜单 → **终端**
2. 输入以下命令（**记得改为你的目录名**）：

```bash
# 进入前端目录
cd /www/wwwroot/你的目录名/client

# 安装依赖
npm install

# 构建项目
npm run build
```

**示例：如果你的目录名是 `tongzhi`：**
```bash
cd /www/wwwroot/tongzhi/client
npm install
npm run build
```

---

**方法三：如果 npm 命令找不到**

如果上述方法都提示 `npm: command not found`，使用完整路径：

```bash
# 1. 先查看安装的 Node.js 版本
ls /www/server/nodejs/

# 2. 确认有 v18.x.x 或 v20.x.x 版本
# 如果只有 v16.x.x，请先在宝塔软件商店安装 Node.js 18

# 3. 使用 Node.js 18 的完整路径（根据实际版本修改）
/www/server/nodejs/v24.12.0/bin/npm install
/www/server/nodejs/v24.12.0/bin/npm run build
```

> ⚠️ **注意**：
> - 必须使用 Node.js 18 或更高版本
> - 如果使用 v16.x.x 会报错：`Unsupported engine`
> - 请将 `v18.20.0` 替换为你实际安装的版本号

#### 4.2 常见构建错误及解决

**错误 1：npm: command not found**

即使在宝塔终端中也可能找不到 npm 命令（特别是 Node.js 24）

**解决方案：**
```bash
# 在终端中先执行这条命令
export PATH=/www/server/nodejs/v24.12.0/bin:$PATH

# 然后再执行构建
npm install
npm run build
```

> 💡 **提示**：每次打开新的终端窗口都需要先执行 export 命令

---

**错误 2：Unexpected end of file in JSON**

错误信息：
```
../package.json:2:0:
ERROR: Unexpected end of file in JSON
```

**原因**：项目根目录的 `package.json` 文件损坏或为空

**解决方案：**

```bash
# 1. 进入项目根目录
cd /www/wwwroot/你的目录名

# 2. 删除损坏的 package.json
rm -f package.json

# 3. 创建正确的 package.json
cat > package.json << 'EOF'
{
  "name": "youjiandingshi",
  "version": "1.0.0",
  "description": "消息通知系统",
  "private": true
}
EOF

# 4. 回到 client 目录重新构建
cd client
export PATH=/www/server/nodejs/v24.12.0/bin:$PATH
npm run build
```

**一键修复命令：**
```bash
cd /www/wwwroot/你的目录名 && rm -f package.json && cat > package.json << 'EOF'
{
  "name": "youjiandingshi",
  "version": "1.0.0",
  "description": "消息通知系统",
  "private": true
}
EOF
cd client && export PATH=/www/server/nodejs/v24.12.0/bin:$PATH && npm run build
```

---

**错误 3：npm 警告信息**

可能会看到以下警告：
```
npm warn Unknown global config "--init.module"
2 moderate severity vulnerabilities
```

**说明**：这些都是**警告**，不是错误，不影响构建和运行，可以忽略。

---

#### 4.3 验证构建结果
1. 宝塔面板 → **文件** → 进入 `/www/wwwroot/你的目录名/client/`
2. 确认存在 `dist` 目录
3. 进入 `dist` 目录，应该看到：
   - `index.html`
   - `assets/` 文件夹（包含js、css等）

**成功的构建输出示例：**
```
vite v5.4.21 building for production...
✓ 1234 modules transformed.
dist/index.html                   0.45 kB │ gzip:  0.30 kB
dist/assets/index-abc123.css      2.34 kB │ gzip:  1.23 kB
dist/assets/index-xyz789.js     123.45 kB │ gzip: 45.67 kB
✓ built in 3.45s
```

---

### 第五步：配置Nginx

#### 5.1 添加网站
1. 宝塔面板 → **网站** → 点击 **"添加站点"**
2. 填写网站信息：
   - **域名**：填写你的域名（如 `notification.yourdomain.com`）
     - 如果没有域名，可以填写服务器IP地址
   - **根目录**：选择 `/www/wwwroot/你的目录名/client/dist`
     - 例如：`/www/wwwroot/notification/client/dist`
     - 或：`/www/wwwroot/tongzhi/client/dist`
   - **FTP**：不创建
   - **数据库**：不创建（已经创建过了）
   - **PHP版本**：选择 **"纯静态"**
3. 点击 **"提交"**

> ⚠️ **注意**：根目录一定要选择到 `dist` 文件夹，不是 `client` 文件夹！

#### 5.2 配置Nginx反向代理
1. 在网站列表中，找到刚创建的站点
2. 点击右侧的 **"设置"** 按钮
3. 进入 **"配置文件"** 选项卡
4. 找到 `server { ... }` 配置块
5. 在 `location / { ... }` 之前添加以下配置：

```nginx
# API 反向代理到后端服务
location /api/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    
    # WebSocket 支持
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    
    # 传递真实客户端信息
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # 缓存相关
    proxy_cache_bypass $http_upgrade;
    
    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
```

6. 修改 `location / { ... }` 配置，确保支持Vue Router：
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

7. 点击 **"保存"**

#### 5.3 完整的Nginx配置示例
如果不确定如何修改，可以参考以下完整配置：

```nginx
server {
    listen 80;
    server_name notification.yourdomain.com;  # 改为你的域名或IP
    
    root /www/wwwroot/notification/client/dist;
    index index.html;
    
    charset utf-8;
    
    # API 反向代理
    location /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 前端路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }
}
```

---

### 第六步：使用安装向导完成配置 ⭐

#### 6.1 访问网站
1. 打开浏览器
2. 访问你配置的域名或IP地址
   - 例如：`http://notification.yourdomain.com`
   - 或：`http://你的服务器IP`
3. **系统会自动跳转到安装向导页面** 🎉

#### 6.2 安装向导 - 4步轻松完成

**🔍 步骤1：环境检查**
- 系统自动检测：
  - ✅ 后端服务是否运行
  - ✅ 数据库配置状态
  - ✅ 数据库连接状态
  - ✅ 数据表是否初始化
- 首次安装时，只有"后端服务"会显示 ✅
- 其他项显示"未配置"或"等待配置"是正常的
- 点击 **"下一步"** 进入配置步骤

**🗄️ 步骤2：数据库配置（重要）⭐**

这一步会自动生成配置文件，无需手动创建 `.env`！

1. **填写数据库信息**（在第二步创建的数据库）：
   ```
   数据库地址: localhost
   端口: 3306
   数据库名: notification_system
   用户名: notification_user
   密码: [你在第二步设置的密码]
   ```

2. **点击"测试并保存配置"按钮**
   - 系统会先测试数据库连接
   - 测试成功后自动生成 `.env` 配置文件
   - 显示"配置保存成功"提示

3. **如果提示需要初始化数据库**：
   - 页面会显示初始化命令
   - 点击"复制"按钮
   - 在宝塔终端执行：
     ```bash
     cd /www/wwwroot/notification/server
     node import-complete-db.js
     ```
   - 返回页面点击"重新检查"

4. **配置保存成功后，点击"下一步"**

**👤 步骤3：创建管理员账号**

有两个选项：

**选项A：使用默认账号（推荐快速开始）**
- 用户名：`admin`
- 密码：`admin123`
- 点击 **"使用默认账号"** 按钮
- ⚠️ **重要**：登录后请立即修改密码

**选项B：创建自定义账号**
- 自定义用户名（至少3位字符）
- 自定义密码（至少6位字符）
- 可选填昵称和邮箱
- 点击 **"创建新账号"** 按钮

**⏳ 系统自动重启**
- 点击按钮后，系统会自动：
  1. 创建安装锁定文件（防止重复安装）
  2. 触发后端服务重启
  3. 重新加载配置
- 预计需要 3-5 秒
- 页面会显示"系统正在重启..."提示

**🎉 步骤4：完成安装**
- 重启完成后自动进入此步骤
- 显示安装摘要信息
- 显示管理员账号
- 显示快速开始指南
- 点击 **"立即登录"** 进入系统

#### 6.3 登录系统
1. 使用刚才创建的管理员账号登录
2. **重要**：如果使用默认账号，首次登录后立即修改密码
   - 点击右上角头像 → **"个人中心"**
   - 点击 **"修改密码"**

---

## 🎯 新版安装向导的优势

✨ **自动生成配置** - 无需手动创建 `.env` 文件
✨ **自动重启服务** - 配置保存后自动重启，无需手动操作
✨ **自动检测环境** - 实时检测各项配置状态
✨ **一键初始化** - 复制命令即可完成数据库初始化
✨ **可视化配置** - 在浏览器中完成所有配置
✨ **友好提示** - 每步都有详细说明和错误提示
✨ **防止重复安装** - 安装完成后自动锁定，防止误操作
✨ **安全可靠** - 自动生成随机 JWT 密钥

---

## ⚙️ 配置邮箱SMTP

登录后需要配置邮箱才能发送通知：

### 1. 进入邮箱配置
1. 点击左侧菜单 **"邮箱配置"**
2. 点击 **"添加配置"**

### 2. 填写SMTP信息

**QQ邮箱配置：**
- **SMTP服务器**：`smtp.qq.com`
- **端口**：`465`
- **发件人邮箱**：你的QQ邮箱（如 `123456789@qq.com`）
- **授权码**：QQ邮箱授权码（不是QQ密码）
- **发件人名称**：自定义（如"通知系统"）
- **启用SSL**：✅ 勾选

**163邮箱配置：**
- **SMTP服务器**：`smtp.163.com`
- **端口**：`465`
- **发件人邮箱**：你的163邮箱
- **授权码**：163邮箱授权码
- **发件人名称**：自定义
- **启用SSL**：✅ 勾选

### 3. 获取邮箱授权码

**QQ邮箱：**
1. 登录QQ邮箱网页版
2. 点击 **"设置"** → **"账户"**
3. 找到 **"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"**
4. 开启 **"POP3/SMTP服务"** 或 **"IMAP/SMTP服务"**
5. 按提示发送短信验证
6. 获得授权码（16位字符）

**163邮箱：**
1. 登录163邮箱网页版
2. 点击 **"设置"** → **"POP3/SMTP/IMAP"**
3. 开启 **"SMTP服务"**
4. 按提示操作获取授权码

### 4. 测试配置
1. 填写完SMTP信息后，点击 **"测试"** 按钮
2. 系统会发送测试邮件
3. 测试成功后，点击 **"启用"** 激活配置

---

## 🔧 常见问题排查

### 问题1：无法访问网站
**症状**：浏览器显示"无法访问此网站"

**解决方案**：
1. 检查防火墙是否开放80端口
   - 宝塔面板 → **安全** → 添加端口 `80`
2. 检查服务器安全组规则
   - 如果是阿里云/腾讯云，需要在控制台添加安全组规则
3. 检查Nginx是否运行
   - 宝塔面板 → **软件商店** → Nginx → 确认状态为"运行中"

### 问题2：页面显示但API请求失败
**症状**：网站能打开，但提示"网络错误"或"连接失败"

**解决方案**：
1. 检查后端服务是否运行
   - 宝塔面板 → PM2管理器 → 查看 `notification-server` 状态
2. 检查后端日志
   - PM2管理器 → 点击项目的 **"日志"** 按钮
   - 查看是否有错误信息
3. 检查Nginx反向代理配置
   - 确认 `location /api/` 配置正确
   - 确认 `proxy_pass http://127.0.0.1:3000;` 端口正确

### 问题3：数据库连接失败
**症状**：后端日志显示"❌ 数据库连接失败"

**解决方案**：
1. 检查 `.env` 文件配置
   - 数据库名、用户名、密码是否正确
   - 注意不要有多余的空格或引号
2. 检查MySQL服务是否运行
   - 宝塔面板 → **软件商店** → MySQL → 确认运行中
3. 测试数据库连接
   - 宝塔面板 → **数据库** → 找到数据库 → 点击"管理"
   - 如果能打开phpMyAdmin，说明数据库正常

### 问题4：邮件发送失败
**症状**：创建通知后，发送日志显示"失败"

**解决方案**：
1. 检查SMTP配置
   - 邮箱地址、授权码是否正确
   - 注意是授权码，不是邮箱登录密码
2. 检查端口和SSL设置
   - QQ/163邮箱使用 465 端口 + SSL
3. 检查防火墙
   - 确保服务器能访问外网的465端口
4. 查看详细错误信息
   - 发送监控页面 → 点击失败记录 → 查看错误详情

### 问题5：定时任务不执行
**症状**：创建的定时通知到时间不发送

**解决方案**：
1. 检查任务状态
   - 通知管理 → 确认任务状态为"运行中"
2. 检查服务器时间
   - 宝塔面板 → **终端** → 输入 `date`
   - 确认服务器时间正确
3. 检查后端服务是否持续运行
   - PM2管理器 → 查看服务运行时长
   - 如果频繁重启，查看日志找出原因

### 问题6：Node 项目安装依赖失败
**症状**：添加 Node 项目时提示"npm install 失败"或项目无法启动

**解决方案**：

**方案一：检查配置**
1. 确认**没有勾选"不安装node_module"**选项
2. 确认选择了正确的包管理器（npm 或 pnpm）
3. ⚠️ **确认 Node 版本选择 18.x 或 20.x**（不是 16.x）

**方案二：手动安装依赖**
1. 宝塔面板 → **终端**
2. 执行：
   ```bash
   cd /www/wwwroot/notification/server
   npm install --production
   ```
3. 如果 npm 速度慢，使用国内镜像：
   ```bash
   npm config set registry https://registry.npmmirror.com
   npm install --production
   ```
4. 安装完成后，在 Node 项目管理中重新启动项目

**方案三：删除旧的 node_modules**
1. 如果上传了 Windows 环境的 node_modules，先删除：
   ```bash
   cd /www/wwwroot/notification/server
   rm -rf node_modules
   ```
2. 重新添加 Node 项目，让宝塔自动安装依赖

---

### 问题7：npm: command not found（在宝塔终端中）
**症状**：即使在宝塔文件管理器的终端中，也提示 `npm: command not found`

**原因**：Node.js 24 太新，宝塔的环境变量配置脚本可能还没更新

**解决方案**：

**临时解决（每次打开终端都需要）：**
```bash
export PATH=/www/server/nodejs/v24.12.0/bin:$PATH
```

**永久解决：**
```bash
# 创建全局软链接
ln -sf /www/server/nodejs/v24.12.0/bin/node /usr/local/bin/node
ln -sf /www/server/nodejs/v24.12.0/bin/npm /usr/local/bin/npm

# 验证
node -v
npm -v
```

---

### 问题8：构建时报错 "Unexpected end of file in JSON"
**症状**：执行 `npm run build` 时报错：
```
../package.json:2:0:
ERROR: Unexpected end of file in JSON
```

**原因**：项目根目录的 `package.json` 文件损坏、为空或格式错误

**解决方案**：

**快速修复（推荐）：**
```bash
cd /www/wwwroot/你的目录名
rm -f package.json
cat > package.json << 'EOF'
{
  "name": "youjiandingshi",
  "version": "1.0.0",
  "description": "消息通知系统",
  "private": true
}
EOF
cd client
export PATH=/www/server/nodejs/v24.12.0/bin:$PATH
npm run build
```

**检查和手动修复：**
```bash
# 1. 查看文件内容
cd /www/wwwroot/你的目录名
cat package.json

# 2. 如果文件为空或损坏，使用宝塔文件管理器编辑
# 确保内容是有效的 JSON 格式
```

---

### 问题9：构建前端时报错 "Unsupported engine"
**症状**：执行 `npm install` 或 `npm run build` 时提示：
```
npm WARN EBADENGINE Unsupported engine
npm WARN EBADENGINE required: { node: '^18.0.0 || >=20.0.0' }
npm WARN EBADENGINE current: { node: 'v16.20.2' }
```

**原因**：Node.js 版本太低，项目需要 Node.js 18 或更高版本

**解决方案**：

**步骤 1：安装 Node.js 18**
1. 宝塔面板 → **软件商店**
2. 搜索 **"Node 版本管理器"**
3. 点击 **"设置"**
4. 安装 **Node.js 18.x** 或 **20.x**

**步骤 2：使用 Node.js 18 构建**
```bash
# 查看已安装的版本
ls /www/server/nodejs/

# 使用 Node.js 18（根据实际版本修改）
cd /www/wwwroot/你的目录名/client
/www/server/nodejs/v18.20.0/bin/npm install
/www/server/nodejs/v18.20.0/bin/npm run build
```

**步骤 3：更新 Node 项目配置**
1. 在 Node 项目管理中，找到后端项目
2. 点击"设置"
3. 将 Node 版本改为 **18.x 或 20.x**
4. 重启项目

---

## 🔒 安全建议

### 1. 修改默认密码
- 首次登录后立即修改管理员密码
- 密码建议：至少8位，包含字母、数字、符号

### 2. 配置HTTPS（推荐）
1. 宝塔面板 → **网站** → 找到站点 → **"设置"**
2. 点击 **"SSL"** 选项卡
3. 选择 **"Let's Encrypt"**（免费）或上传自己的证书
4. 点击 **"申请"** 或 **"部署"**
5. 开启 **"强制HTTPS"**

### 3. 定期备份
1. 宝塔面板 → **计划任务**
2. 添加备份任务：
   - **任务类型**：备份网站
   - **执行周期**：每天或每周
   - **备份网站**：选择 notification 站点
3. 添加数据库备份任务：
   - **任务类型**：备份数据库
   - **备份数据库**：选择 notification_system

### 4. 限制访问IP（可选）
如果只在公司内网使用：
1. 宝塔面板 → **安全**
2. 添加访问规则，只允许特定IP访问

---

## 📊 性能优化建议

### 1. 启用Nginx缓存
在网站配置中已包含静态资源缓存配置，无需额外操作。

### 2. 配置PM2自动重启
PM2已自动配置，服务异常时会自动重启。

### 3. 定期清理日志
1. 发送监控页面 → 定期删除旧日志
2. 或在数据库中设置日志保留策略

---

## 📝 极简安装流程（6步完成）⭐

**新版本安装超级简单，只需6步：**

### 第一步：创建目录并上传文件
- 在 `/www/wwwroot/` 下创建目录（如 `notification`、`tongzhi` 等）
- 上传项目文件到该目录
- ⚠️ 建议不要上传 `node_modules` 文件夹（太大且可能不兼容）

### 第二步：创建数据库
- 在宝塔中创建空数据库（记住数据库名、用户名、密码）

### 第三步：添加 Node 项目
- 宝塔面板 → 网站 → Node 项目 → 添加 Node 项目
- 项目目录填写：`/www/wwwroot/你的目录名/server`
- ⚠️ **不要勾选"不安装node_module"选项**
- 让宝塔自动安装依赖（2-5分钟）

### 第四步：构建前端 ⚠️ 重点
- **方法一（推荐）**：宝塔面板 → 文件 → 进入 `client` 目录 → 点击顶部"终端"按钮
- **方法二**：宝塔面板 → 终端 → 输入命令
- **先添加环境变量**（特别是 Node.js 24）：
  ```bash
  export PATH=/www/server/nodejs/v24.12.0/bin:$PATH
  ```
- 然后执行构建：
  ```bash
  npm install
  npm run build
  ```
- **如果遇到错误**，查看下方"常见问题"章节

### 第五步：添加网站并配置 Nginx
- 添加网站，根目录：`/www/wwwroot/你的目录名/client/dist`
- 配置反向代理

### 第六步：访问安装向导 🎉
- 打开网站，在浏览器中填写数据库信息
- 系统自动生成配置、自动重启
- 完成！

> 💡 **重要提示**：
> - 所有命令中的 `notification` 都要改为你实际创建的目录名
> - 例如你创建的是 `tongzhi`，就把所有 `notification` 改为 `tongzhi`
> - **使用 Node.js 24 时，每次打开终端都要先执行环境变量命令**
> - 如果构建失败，先检查根目录的 `package.json` 文件是否正常

---

## 🔍 新版安装向导的强大功能

### ✅ 安装向导**可以**做的：
- ✅ **自动生成 `.env` 配置文件**（无需手动创建）
- ✅ 检查后端服务是否运行
- ✅ 测试数据库连接
- ✅ 保存数据库配置
- ✅ 提供数据库初始化命令（一键复制）
- ✅ 创建管理员账号
- ✅ **自动重启服务**（PM2 自动重启）
- ✅ 防止重复安装（安装锁定机制）

### ❌ 仍需手动完成的：
- ❌ 上传项目文件
- ❌ 创建数据库（在宝塔中）
- ❌ 启动后端服务（在 PM2 中）
- ❌ 构建前端项目（npm run build）
- ❌ 配置 Nginx

> 💡 **总结**：新版本已实现**像 WordPress 一样的安装体验**！数据库配置、文件生成、服务重启都自动完成，大大简化了安装流程。

---

## 🔄 如何重新安装？

如果需要重新安装系统（例如更换数据库），请按以下步骤操作：

### 方法一：删除配置文件（推荐）

1. **停止后端服务**
   - 宝塔面板 → PM2管理器 → 停止 `notification-server`

2. **删除配置文件**
   - 进入 `/www/wwwroot/notification/server/` 目录
   - 删除 `.env` 文件
   - 删除 `.install.lock` 文件

3. **清空数据库（可选）**
   - 如果要使用新数据库，在宝塔中删除旧数据库
   - 创建新的空数据库

4. **重启后端服务**
   - PM2管理器 → 重启 `notification-server`
   - 服务会自动进入安装模式

5. **重新访问安装向导**
   - 访问网站，重新完成安装流程

### 方法二：完全重装

1. 删除整个项目目录
2. 删除数据库
3. 按照完整安装流程重新部署

> ⚠️ **警告**：重新安装会清空所有数据，请务必先备份！

---

## 🔧 数据库修复工具

如果遇到通知编辑或执行时报错 `SyntaxError: Unexpected non-whitespace character after JSON`，说明数据库中有旧的非 JSON 格式数据。

### 运行修复脚本

在宝塔终端中执行：

```bash
cd /www/wwwroot/tongzhi/server
/www/server/nodejs/v24.12.0/bin/node fix-recipients.js
```

**脚本功能：**
- 自动检测并修复 `notifications` 表中的 `recipients` 字段
- 将纯文本格式转换为 JSON 数组格式
- 显示修复进度和结果

**示例输出：**
```
🔧 开始修复 recipients 字段格式...

📊 找到 3 条通知记录

❌ ID 1: "测试通知"
   原始值: 2099156872@qq.com
   ✅ 修复为: ["2099156872@qq.com"]

═══════════════════════════════════════
✅ 修复完成！
   - 已修复: 1 条
   - 已是正确格式: 2 条
   - 总计: 3 条
═══════════════════════════════════════
```

修复完成后，重启后端服务即可正常使用。

---

## 🎯 快速检查清单

安装完成后，请确认以下项目：

- [ ] 后端服务在PM2中显示"运行中"
- [ ] 访问网站能正常打开
- [ ] 完成了4步安装向导
- [ ] 系统自动重启成功
- [ ] 能成功登录系统
- [ ] 已修改默认管理员密码（如使用默认账号）
- [ ] SMTP邮箱配置成功并测试通过
- [ ] 创建测试通知并成功发送
- [ ] 定时任务能正常执行
- [ ] 已配置数据库定期备份

---

## 📞 获取帮助

如果遇到问题：

1. **查看日志**
   - 后端日志：PM2管理器 → 项目日志
   - Nginx日志：网站设置 → 日志
   - 系统日志：发送监控页面

2. **提交Issue**
   - GitHub: https://github.com/xiaolou888/youjiandingshi/issues

3. **常见问题文档**
   - 查看 README.md 中的"常见问题"章节

---

## 🎉 安装完成

恭喜！您已成功在宝塔面板上部署消息通知系统。

**下一步操作：**
1. 配置SMTP邮箱
2. 添加收件人
3. 创建第一个通知任务
4. 体验自动发送功能

祝使用愉快！ 📧✨

