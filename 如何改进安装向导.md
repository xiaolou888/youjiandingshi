# ğŸ”§ å¦‚ä½•æ”¹è¿›å®‰è£…å‘å¯¼ - å®ç°å®‰è£…æ—¶å¡«å†™æ•°æ®åº“é…ç½®

> æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•æ”¹è¿›é¡¹ç›®ï¼Œè®©å®‰è£…å‘å¯¼èƒ½å¤Ÿåƒ WordPress ä¸€æ ·åœ¨å®‰è£…æ—¶è‡ªåŠ¨å†™å…¥æ•°æ®åº“é…ç½®

---

## ğŸ“‹ å½“å‰é—®é¢˜

### ç°çŠ¶
- âŒ ç”¨æˆ·å¿…é¡»æ‰‹åŠ¨åˆ›å»º `.env` æ–‡ä»¶
- âŒ å¿…é¡»æ‰‹åŠ¨å¡«å†™æ•°æ®åº“é…ç½®
- âŒ å®‰è£…å‘å¯¼åªèƒ½æµ‹è¯•è¿æ¥ï¼Œä¸èƒ½å†™å…¥é…ç½®
- âŒ ç”¨æˆ·ä½“éªŒä¸å¦‚ WordPressã€Discuz ç­‰ç³»ç»Ÿ

### åŸå› 
1. **Node.js çš„ `.env` åŠ è½½æœºåˆ¶**
   - `.env` æ–‡ä»¶åœ¨æœåŠ¡å¯åŠ¨æ—¶é€šè¿‡ `dotenv` åŠ è½½
   - ä¸€æ—¦æœåŠ¡å¯åŠ¨ï¼Œé…ç½®å°±å›ºå®šäº†
   - ä¿®æ”¹ `.env` éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ

2. **å®å¡” PM2 ç¯å¢ƒçš„é™åˆ¶**
   - åœ¨å®‰è£…å‘å¯¼ä¸­æ— æ³•ç›´æ¥é‡å¯ PM2 æœåŠ¡
   - éœ€è¦ç”¨æˆ·æ‰‹åŠ¨åœ¨å®å¡”é¢æ¿ä¸­é‡å¯

---

## ğŸ’¡ æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ JSON é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰â­

**åŸç†ï¼š** ä½¿ç”¨ `config.json` ä»£æ›¿ `.env`ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€è¯»å–å’Œå†™å…¥ã€‚

#### 1. ä¿®æ”¹é…ç½®è¯»å–æ–¹å¼

**ä¿®æ”¹ `server/config/database.js`ï¼š**

```javascript
const mysql = require('mysql2');
const fs = require('fs');
const path = require('path');

// è¯»å–é…ç½®æ–‡ä»¶
function loadConfig() {
  const configPath = path.join(__dirname, '../config.json');
  
  // å¦‚æœé…ç½®æ–‡ä»¶å­˜åœ¨ï¼Œè¯»å–é…ç½®
  if (fs.existsSync(configPath)) {
    const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
    return config.database;
  }
  
  // å¦åˆ™ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆå…¼å®¹æ—§æ–¹å¼ï¼‰
  return {
    host: process.env.DB_HOST || 'localhost',
    user: process.env.DB_USER || 'root',
    password: process.env.DB_PASSWORD || '',
    database: process.env.DB_NAME || 'notification_system',
    port: process.env.DB_PORT || 3306
  };
}

const dbConfig = loadConfig();

// åˆ›å»ºæ•°æ®åº“è¿æ¥æ± 
const pool = mysql.createPool({
  ...dbConfig,
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
});

const promisePool = pool.promise();

module.exports = promisePool;
```

#### 2. æ·»åŠ ä¿å­˜é…ç½®çš„ API

**ä¿®æ”¹ `server/routes/install.js`ï¼Œæ·»åŠ ä¿å­˜é…ç½®æ¥å£ï¼š**

```javascript
const fs = require('fs');
const path = require('path');

/**
 * ä¿å­˜æ•°æ®åº“é…ç½®
 */
router.post('/save-config', async (req, res) => {
  const { host, port, user, password, database } = req.body;

  try {
    // å…ˆæµ‹è¯•è¿æ¥
    const mysql = require('mysql2/promise');
    const connection = await mysql.createConnection({
      host,
      port: port || 3306,
      user,
      password,
      database
    });

    await connection.query('SELECT 1');
    await connection.end();

    // è¿æ¥æˆåŠŸï¼Œä¿å­˜é…ç½®
    const configPath = path.join(__dirname, '../config.json');
    const config = {
      database: {
        host,
        port: port || 3306,
        user,
        password,
        database
      },
      server: {
        port: process.env.PORT || 3000,
        nodeEnv: 'production'
      },
      jwt: {
        secret: generateRandomSecret() // è‡ªåŠ¨ç”Ÿæˆéšæœºå¯†é’¥
      }
    };

    fs.writeFileSync(configPath, JSON.stringify(config, null, 2), 'utf8');

    res.json({
      success: true,
      message: 'é…ç½®å·²ä¿å­˜ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...'
    });

    // å»¶è¿Ÿé‡æ–°åŠ è½½é…ç½®
    setTimeout(() => {
      // é‡æ–°åŠ è½½æ•°æ®åº“è¿æ¥
      require('../config/database');
    }, 1000);

  } catch (error) {
    res.status(400).json({
      success: false,
      message: `ä¿å­˜å¤±è´¥: ${error.message}`
    });
  }
});

// ç”Ÿæˆéšæœºå¯†é’¥
function generateRandomSecret() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
  let secret = '';
  for (let i = 0; i < 32; i++) {
    secret += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return secret;
}
```

#### 3. ä¿®æ”¹å‰ç«¯å®‰è£…å‘å¯¼

**ä¿®æ”¹ `client/src/views/Install.vue`ï¼Œæ·»åŠ ä¿å­˜é…ç½®åŠŸèƒ½ï¼š**

```javascript
// æµ‹è¯•å¹¶ä¿å­˜æ•°æ®åº“è¿æ¥
const testAndSaveConnection = async () => {
  testing.value = true
  dbTestResult.value = null
  
  try {
    // å…ˆæµ‹è¯•è¿æ¥
    await request.post('/api/install/test-db', dbConfig)
    
    // æµ‹è¯•æˆåŠŸï¼Œä¿å­˜é…ç½®
    const response = await request.post('/api/install/save-config', dbConfig)
    
    dbTestResult.value = {
      success: true,
      message: 'æ•°æ®åº“é…ç½®å·²ä¿å­˜ï¼'
    }
    
    ElMessage.success('é…ç½®ä¿å­˜æˆåŠŸ')
  } catch (error) {
    dbTestResult.value = {
      success: false,
      message: error.response?.data?.message || 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®'
    }
  } finally {
    testing.value = false
  }
}
```

**ä¿®æ”¹æŒ‰é’®ï¼š**

```vue
<el-form-item>
  <el-button @click="testAndSaveConnection" :loading="testing" type="primary">
    æµ‹è¯•å¹¶ä¿å­˜é…ç½®
  </el-button>
</el-form-item>
```

#### 4. ä¼˜ç‚¹
- âœ… ç”¨æˆ·å¯ä»¥åœ¨æµè§ˆå™¨ä¸­å®Œæˆæ‰€æœ‰é…ç½®
- âœ… æ— éœ€æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶
- âœ… æ— éœ€é‡å¯æœåŠ¡ï¼ˆè‡ªåŠ¨é‡æ–°åŠ è½½ï¼‰
- âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ¸…æ™°ï¼Œæ˜“äºç®¡ç†

#### 5. ç¼ºç‚¹
- âš ï¸ éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç ç»“æ„
- âš ï¸ JSON æ–‡ä»¶ä¸­å¯†ç æ˜æ–‡å­˜å‚¨ï¼ˆå¯ä»¥åŠ å¯†ï¼‰

---

### æ–¹æ¡ˆäºŒï¼šç”Ÿæˆ .env æ–‡ä»¶ + æç¤ºé‡å¯

**åŸç†ï¼š** å®‰è£…å‘å¯¼ç”Ÿæˆ `.env` æ–‡ä»¶ï¼Œæç¤ºç”¨æˆ·åœ¨å®å¡”ä¸­é‡å¯æœåŠ¡ã€‚

#### 1. æ·»åŠ ç”Ÿæˆ .env çš„ API

**ä¿®æ”¹ `server/routes/install.js`ï¼š**

```javascript
const fs = require('fs');
const path = require('path');

/**
 * ç”Ÿæˆ .env æ–‡ä»¶
 */
router.post('/generate-env', async (req, res) => {
  const { host, port, user, password, database } = req.body;

  try {
    // å…ˆæµ‹è¯•è¿æ¥
    const mysql = require('mysql2/promise');
    const connection = await mysql.createConnection({
      host,
      port: port || 3306,
      user,
      password,
      database
    });

    await connection.query('SELECT 1');
    await connection.end();

    // ç”Ÿæˆ .env å†…å®¹
    const envContent = `# æ•°æ®åº“é…ç½®
DB_HOST=${host}
DB_USER=${user}
DB_PASSWORD=${password}
DB_NAME=${database}
DB_PORT=${port || 3306}

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=production

# JWTå¯†é’¥
JWT_SECRET=${generateRandomSecret()}
`;

    // å†™å…¥ .env æ–‡ä»¶
    const envPath = path.join(__dirname, '../.env');
    fs.writeFileSync(envPath, envContent, 'utf8');

    res.json({
      success: true,
      message: '.env æ–‡ä»¶å·²ç”Ÿæˆï¼Œè¯·åœ¨å®å¡” PM2 ç®¡ç†å™¨ä¸­é‡å¯æœåŠ¡',
      needRestart: true
    });

  } catch (error) {
    res.status(400).json({
      success: false,
      message: `ç”Ÿæˆå¤±è´¥: ${error.message}`
    });
  }
});
```

#### 2. ä¿®æ”¹å‰ç«¯æç¤º

**ä¿®æ”¹ `client/src/views/Install.vue`ï¼š**

```vue
<el-alert
  v-if="envGenerated"
  title="é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
  type="warning"
  :closable="false"
>
  <p>.env æ–‡ä»¶å·²æˆåŠŸç”Ÿæˆï¼</p>
  <p><strong>é‡è¦ï¼šè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤é‡å¯åç«¯æœåŠ¡ï¼š</strong></p>
  <ol style="margin-top: 10px; padding-left: 20px;">
    <li>æ‰“å¼€å®å¡”é¢æ¿</li>
    <li>è¿›å…¥ è½¯ä»¶å•†åº— â†’ PM2ç®¡ç†å™¨</li>
    <li>æ‰¾åˆ° notification-server é¡¹ç›®</li>
    <li>ç‚¹å‡»"é‡å¯"æŒ‰é’®</li>
    <li>è¿”å›æ­¤é¡µé¢ï¼Œç‚¹å‡»"é‡æ–°æ£€æŸ¥"</li>
  </ol>
</el-alert>
```

#### 3. ä¼˜ç‚¹
- âœ… ä¿æŒ `.env` çš„ä½¿ç”¨ä¹ æƒ¯
- âœ… ä»£ç æ”¹åŠ¨è¾ƒå°
- âœ… ç¬¦åˆ Node.js æœ€ä½³å®è·µ

#### 4. ç¼ºç‚¹
- âŒ éœ€è¦ç”¨æˆ·æ‰‹åŠ¨é‡å¯æœåŠ¡
- âŒ ç”¨æˆ·ä½“éªŒä¸å¦‚æ–¹æ¡ˆä¸€æµç•…

---

### æ–¹æ¡ˆä¸‰ï¼šé¦–æ¬¡å¯åŠ¨å‘å¯¼ï¼ˆæœ€ç®€å•ï¼‰

**åŸç†ï¼š** ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰ `.env` æ–‡ä»¶ï¼Œåç«¯ä¸å¯åŠ¨æ•°æ®åº“è¿æ¥ï¼Œåªæä¾›å®‰è£… APIã€‚

#### 1. ä¿®æ”¹å¯åŠ¨é€»è¾‘

**ä¿®æ”¹ `server/index.js`ï¼š**

```javascript
const fs = require('fs');
const path = require('path');

// æ£€æŸ¥æ˜¯å¦å·²é…ç½®
const envPath = path.join(__dirname, '.env');
const isConfigured = fs.existsSync(envPath);

if (!isConfigured) {
  console.log('âš ï¸  æœªæ£€æµ‹åˆ°é…ç½®æ–‡ä»¶ï¼Œè¿›å…¥å®‰è£…æ¨¡å¼...');
  // åªå¯åŠ¨å®‰è£…ç›¸å…³çš„è·¯ç”±
  app.use('/api/install', require('./routes/install'));
  
  app.get('*', (req, res) => {
    res.json({ 
      success: false, 
      message: 'è¯·å…ˆå®Œæˆå®‰è£…é…ç½®',
      needInstall: true 
    });
  });
} else {
  // æ­£å¸¸å¯åŠ¨æ‰€æœ‰åŠŸèƒ½
  require('dotenv').config();
  // ... å…¶ä»–è·¯ç”±å’ŒåŠŸèƒ½
}
```

#### 2. å®‰è£…å®Œæˆåé‡å¯

ç”Ÿæˆ `.env` åï¼Œä½¿ç”¨ `process.exit(0)` é€€å‡ºè¿›ç¨‹ï¼ŒPM2 ä¼šè‡ªåŠ¨é‡å¯ã€‚

```javascript
router.post('/complete', async (req, res) => {
  // ... ç”Ÿæˆ .env æ–‡ä»¶
  
  res.json({
    success: true,
    message: 'å®‰è£…å®Œæˆï¼Œç³»ç»Ÿæ­£åœ¨é‡å¯...'
  });
  
  // å»¶è¿Ÿé€€å‡ºï¼Œè®©å“åº”å…ˆå‘é€
  setTimeout(() => {
    process.exit(0); // PM2 ä¼šè‡ªåŠ¨é‡å¯
  }, 1000);
});
```

#### 3. ä¼˜ç‚¹
- âœ… è‡ªåŠ¨é‡å¯ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- âœ… ç”¨æˆ·ä½“éªŒæœ€å¥½

#### 4. ç¼ºç‚¹
- âš ï¸ ä¾èµ– PM2 çš„è‡ªåŠ¨é‡å¯åŠŸèƒ½
- âš ï¸ ä»£ç æ”¹åŠ¨è¾ƒå¤§

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### å¯¹äºå½“å‰é¡¹ç›®
**æ¨èä½¿ç”¨æ–¹æ¡ˆäºŒ**ï¼ˆç”Ÿæˆ .env + æç¤ºé‡å¯ï¼‰ï¼š
- æ”¹åŠ¨æœ€å°
- å…¼å®¹ç°æœ‰æ¶æ„
- ç”¨æˆ·åªéœ€é‡å¯ä¸€æ¬¡æœåŠ¡

### å¯¹äºæ–°é¡¹ç›®
**æ¨èä½¿ç”¨æ–¹æ¡ˆä¸€**ï¼ˆJSON é…ç½®æ–‡ä»¶ï¼‰ï¼š
- æ›´çµæ´»
- æ›´ç°ä»£åŒ–
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

---

## ğŸ“ å®æ–½æ­¥éª¤

### å¦‚æœè¦å®ç°æ–¹æ¡ˆäºŒï¼ˆæœ€å¿«ï¼‰

1. **ä¿®æ”¹ `server/routes/install.js`**
   - æ·»åŠ  `/generate-env` æ¥å£
   - å®ç°ç”Ÿæˆ `.env` æ–‡ä»¶çš„é€»è¾‘

2. **ä¿®æ”¹ `client/src/views/Install.vue`**
   - ä¿®æ”¹"æµ‹è¯•è¿æ¥"æŒ‰é’®ä¸º"æµ‹è¯•å¹¶ç”Ÿæˆé…ç½®"
   - æ·»åŠ é‡å¯æç¤º

3. **æ›´æ–°æ•™ç¨‹**
   - è¯´æ˜å¯ä»¥åœ¨å®‰è£…å‘å¯¼ä¸­é…ç½®æ•°æ®åº“
   - æç¤ºéœ€è¦é‡å¯æœåŠ¡

4. **æµ‹è¯•æµç¨‹**
   - åˆ é™¤ `.env` æ–‡ä»¶
   - å¯åŠ¨æœåŠ¡
   - è®¿é—®å®‰è£…å‘å¯¼
   - å¡«å†™æ•°æ®åº“ä¿¡æ¯
   - ç”Ÿæˆé…ç½®
   - é‡å¯æœåŠ¡
   - å®Œæˆå®‰è£…

---

## ğŸ”’ å®‰å…¨å»ºè®®

æ— è®ºä½¿ç”¨å“ªç§æ–¹æ¡ˆï¼Œéƒ½è¦æ³¨æ„ï¼š

1. **é…ç½®æ–‡ä»¶æƒé™**
   - `.env` æˆ– `config.json` åº”è®¾ç½®ä¸ºåªè¯»
   - é˜²æ­¢è¢« Web æœåŠ¡å™¨ç›´æ¥è®¿é—®

2. **å¯†ç åŠ å¯†**
   - è€ƒè™‘å¯¹é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç è¿›è¡ŒåŠ å¯†
   - ä½¿ç”¨ `crypto` æ¨¡å—åŠ å¯†æ•æ„Ÿä¿¡æ¯

3. **å®‰è£…é”å®š**
   - å®‰è£…å®Œæˆåï¼Œç¦ç”¨å®‰è£…æ¥å£
   - é˜²æ­¢é‡å¤å®‰è£…è¦†ç›–é…ç½®

---

## ğŸ’¬ æ€»ç»“

**å½“å‰é¡¹ç›®çš„é™åˆ¶æ˜¯æŠ€æœ¯é€‰å‹å¯¼è‡´çš„**ï¼Œä¸æ˜¯è®¾è®¡ç¼ºé™·ã€‚Node.js çš„ `.env` æœºåˆ¶å°±æ˜¯è¿™æ ·å·¥ä½œçš„ã€‚

**å¦‚æœæ‚¨éœ€è¦è¿™ä¸ªåŠŸèƒ½**ï¼Œå¯ä»¥ï¼š
1. åœ¨é¡¹ç›® GitHub æ Issue
2. æˆ–è€…æŒ‰ç…§æœ¬æ–‡æ¡£çš„æ–¹æ¡ˆè‡ªè¡Œæ”¹è¿›
3. æˆ–è€…æ¥å—å½“å‰çš„æ‰‹åŠ¨é…ç½®æ–¹å¼ï¼ˆå…¶å®ä¹Ÿä¸å¤æ‚ï¼‰

å¯¹äºå®å¡”ç”¨æˆ·æ¥è¯´ï¼Œæ‰‹åŠ¨åˆ›å»ºä¸€æ¬¡ `.env` æ–‡ä»¶å¹¶ä¸å›°éš¾ï¼Œè€Œä¸”è¿™ç§æ–¹å¼æ›´å®‰å…¨ã€æ›´ç¬¦åˆ Node.js çš„æœ€ä½³å®è·µã€‚




