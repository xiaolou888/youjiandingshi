# 🧪 安装测试指南 - 方案三实施验证

> 本文档用于测试新的安装流程是否正常工作

---

## 📋 测试前准备

### 环境要求
- ✅ 宝塔面板已安装
- ✅ PM2管理器已安装
- ✅ MySQL 5.7+ 已安装
- ✅ Nginx 已安装
- ✅ Node.js 16+ 已安装

### 测试文件清单
确认以下文件已修改：
- ✅ `server/index.js` - 添加了安装模式检测
- ✅ `server/routes/install.js` - 添加了保存配置和完成安装接口
- ✅ `client/src/views/Install.vue` - 修改了安装向导界面和逻辑
- ✅ `宝塔安装详细教程.md` - 更新了安装说明

---

## 🧪 测试步骤

### 测试1：首次启动（安装模式）

**目标**：验证后端能正确进入安装模式

**步骤**：
1. 确保 `server/.env` 文件不存在
2. 确保 `server/.install.lock` 文件不存在
3. 启动后端服务：`cd server && npm run dev`
4. 查看控制台输出

**预期结果**：
```
╔════════════════════════════════════════════╗
║     ⚙️  消息通知系统 - 安装模式            ║
║     端口: 3000                             ║
║     请访问前端页面完成安装配置             ║
╚════════════════════════════════════════════╝
```

**验证**：
- [ ] 控制台显示"安装模式"
- [ ] 访问 `http://localhost:3000/api/health` 返回 `needInstall: true`
- [ ] 访问其他 API 返回 503 错误

---

### 测试2：环境检查（步骤1）

**目标**：验证安装向导能正确检测环境

**步骤**：
1. 启动前端：`cd client && npm run dev`
2. 访问 `http://localhost:5173`
3. 应该自动进入安装向导页面

**预期结果**：
- 后端服务：✅ 正常
- 数据库配置：⚠️ 未配置
- 数据库连接：⚠️ 等待配置
- 数据表：⚠️ 未初始化

**验证**：
- [ ] 页面显示4步进度条
- [ ] 当前在步骤1
- [ ] 只有"后端服务"显示绿色 ✅
- [ ] 其他项显示黄色 ⚠️
- [ ] 显示提示："请点击下一步，在第二步中填写数据库配置信息"
- [ ] "下一步"按钮可点击

---

### 测试3：数据库配置（步骤2）

**目标**：验证能正确保存数据库配置并生成 .env 文件

**前提**：
- 在宝塔中创建好测试数据库
- 记录数据库名、用户名、密码

**步骤**：
1. 点击"下一步"进入步骤2
2. 填写数据库信息：
   - 数据库地址：`localhost`
   - 端口：`3306`
   - 数据库名：`test_notification`
   - 用户名：`test_user`
   - 密码：`test_password`
3. 点击"测试并保存配置"按钮
4. 等待响应

**预期结果**：
- 显示"✅ 配置保存成功！"
- 提示"数据库配置已保存！配置文件已自动生成。"
- "下一步"按钮变为可点击

**验证**：
- [ ] 连接测试成功
- [ ] 显示成功提示
- [ ] `server/.env` 文件已生成
- [ ] `.env` 文件内容正确：
  ```env
  DB_HOST=localhost
  DB_USER=test_user
  DB_PASSWORD=test_password
  DB_NAME=test_notification
  DB_PORT=3306
  PORT=3000
  NODE_ENV=production
  JWT_SECRET=（随机生成的32位字符串）
  ```
- [ ] JWT_SECRET 是随机生成的
- [ ] 文件包含生成时间注释

---

### 测试4：数据库初始化提示

**目标**：验证系统能正确提示初始化数据库

**步骤**：
1. 点击"重新检查"按钮
2. 查看检查结果

**预期结果**：
- 数据库配置：✅ 已配置
- 数据库连接：✅ 正常
- 数据表：⚠️ 未初始化
- 显示初始化命令和复制按钮

**验证**：
- [ ] 显示需要初始化的警告
- [ ] 显示初始化命令
- [ ] 点击"复制"按钮能复制命令
- [ ] 命令格式正确

**执行初始化**：
1. 复制命令
2. 在终端执行：`cd server && node import-complete-db.js`
3. 等待初始化完成
4. 返回页面点击"重新检查"

**验证初始化后**：
- [ ] 所有检查项都显示 ✅
- [ ] "下一步"按钮可点击

---

### 测试5：创建管理员（步骤3）

**目标**：验证能创建管理员并触发重启

**测试5.1：使用默认账号**

**步骤**：
1. 点击"下一步"进入步骤3
2. 点击"使用默认账号"按钮
3. 观察页面变化

**预期结果**：
- 显示"⏳ 系统正在重启..."提示
- 按钮显示加载状态
- 约3秒后进入步骤4

**验证**：
- [ ] 显示重启提示
- [ ] 按钮变为加载状态
- [ ] 后端服务自动退出（PM2会重启）
- [ ] `server/.install.lock` 文件已创建
- [ ] 锁定文件内容正确（包含安装时间）
- [ ] 3秒后自动进入步骤4

**测试5.2：创建自定义账号**

**步骤**：
1. 重新安装（删除 .env 和 .install.lock）
2. 重复测试1-4
3. 在步骤3填写自定义账号：
   - 用户名：`testadmin`
   - 密码：`test123456`
   - 确认密码：`test123456`
   - 昵称：`测试管理员`
   - 邮箱：`test@example.com`
4. 点击"创建新账号"按钮

**预期结果**：
- 账号创建成功
- 系统自动重启
- 进入步骤4

**验证**：
- [ ] 账号创建成功
- [ ] 系统自动重启
- [ ] 数据库中有新用户记录
- [ ] 密码已加密存储

---

### 测试6：完成安装（步骤4）

**目标**：验证安装完成页面显示正确

**预期结果**：
- 显示"🎉 安装完成！"
- 显示管理员账号信息
- 显示后端地址
- 显示数据库名
- 显示快速开始指南
- 有"立即登录"按钮

**验证**：
- [ ] 页面显示完成信息
- [ ] 管理员账号显示正确
- [ ] 快速开始指南清晰
- [ ] "立即登录"按钮可点击

---

### 测试7：服务重启后状态

**目标**：验证重启后服务进入正常模式

**步骤**：
1. 查看后端控制台输出
2. 访问 `http://localhost:3000/api/health`

**预期结果（控制台）**：
```
╔════════════════════════════════════════════╗
║     📧 消息通知系统后端服务已启动          ║
║     端口: 3000                             ║
║     环境: production                       ║
╚════════════════════════════════════════════╝
✅ 数据库连接成功
```

**预期结果（API）**：
```json
{
  "status": "ok",
  "message": "服务运行正常"
}
```

**验证**：
- [ ] 控制台显示正常模式（不是安装模式）
- [ ] 数据库连接成功
- [ ] API 返回正常状态（无 needInstall 字段）
- [ ] 所有路由都可访问

---

### 测试8：登录系统

**目标**：验证能使用创建的账号登录

**步骤**：
1. 点击"立即登录"按钮
2. 使用管理员账号登录
3. 查看系统首页

**预期结果**：
- 跳转到登录页
- 能成功登录
- 进入系统首页

**验证**：
- [ ] 登录成功
- [ ] 能访问所有功能
- [ ] 用户信息显示正确

---

### 测试9：防止重复安装

**目标**：验证安装锁定机制有效

**步骤**：
1. 登录后，手动访问 `/install` 路径
2. 或删除浏览器 localStorage 后刷新

**预期结果**：
- 检测到已安装
- 自动跳转到登录页
- 显示"系统已完成安装"提示

**验证**：
- [ ] 无法再次进入安装页面
- [ ] 自动跳转到登录页
- [ ] 显示已安装提示

**测试 API 保护**：
```bash
# 尝试再次保存配置
curl -X POST http://localhost:3000/api/install/save-config \
  -H "Content-Type: application/json" \
  -d '{"host":"localhost","user":"root","password":"123","database":"test"}'
```

**预期结果**：
```json
{
  "success": false,
  "message": "系统已完成安装，无法重复配置"
}
```

**验证**：
- [ ] API 返回 403 错误
- [ ] 提示无法重复配置
- [ ] `.env` 文件未被修改

---

### 测试10：重新安装流程

**目标**：验证能正确重新安装

**步骤**：
1. 停止后端服务
2. 删除 `server/.env` 文件
3. 删除 `server/.install.lock` 文件
4. 重启后端服务
5. 访问安装向导

**预期结果**：
- 后端重新进入安装模式
- 能再次完成安装流程

**验证**：
- [ ] 后端显示"安装模式"
- [ ] 安装向导可正常访问
- [ ] 能重新配置数据库
- [ ] 能重新创建管理员
- [ ] 安装完成后正常运行

---

## 🐛 常见问题测试

### 问题1：数据库连接失败

**测试场景**：填写错误的数据库信息

**步骤**：
1. 在步骤2填写错误的密码
2. 点击"测试并保存配置"

**预期结果**：
- 显示"❌ 连接失败"
- 显示具体错误信息
- `.env` 文件未生成
- "下一步"按钮仍然禁用

**验证**：
- [ ] 显示错误提示
- [ ] 错误信息清晰
- [ ] 未生成配置文件
- [ ] 可以重新填写

---

### 问题2：服务未启动

**测试场景**：后端服务未运行

**步骤**：
1. 停止后端服务
2. 访问安装向导

**预期结果**：
- 步骤1显示"后端服务：❌ 未连接"
- 显示错误提示
- "下一步"按钮禁用

**验证**：
- [ ] 正确检测到后端未运行
- [ ] 显示友好的错误提示
- [ ] 无法继续安装

---

### 问题3：PM2 未自动重启

**测试场景**：PM2 配置问题导致未重启

**步骤**：
1. 完成步骤3后
2. 观察 PM2 状态

**预期结果**：
- PM2 自动重启服务
- 服务在3-5秒内恢复运行

**如果未重启**：
- 手动在 PM2 中重启
- 检查 PM2 配置
- 查看 PM2 日志

**验证**：
- [ ] PM2 能自动重启
- [ ] 重启后服务正常
- [ ] 日志无错误

---

## ✅ 测试结果总结

### 功能测试清单

- [ ] 安装模式检测正常
- [ ] 环境检查功能正常
- [ ] 数据库配置保存正常
- [ ] .env 文件生成正确
- [ ] JWT 密钥随机生成
- [ ] 数据库初始化提示正常
- [ ] 使用默认账号功能正常
- [ ] 创建自定义账号功能正常
- [ ] 系统自动重启功能正常
- [ ] 安装锁定机制有效
- [ ] 防止重复安装有效
- [ ] 重新安装流程正常
- [ ] 错误处理友好
- [ ] 用户体验流畅

### 性能测试

- [ ] 安装向导响应速度快
- [ ] 配置保存速度快（< 2秒）
- [ ] 服务重启时间短（< 5秒）
- [ ] 页面加载流畅

### 安全测试

- [ ] JWT 密钥足够随机
- [ ] 密码正确加密存储
- [ ] 安装锁定无法绕过
- [ ] API 保护有效

---

## 📊 测试报告模板

**测试日期**：____________________

**测试环境**：
- 操作系统：____________________
- Node.js 版本：____________________
- MySQL 版本：____________________
- 浏览器：____________________

**测试结果**：
- 通过：____ 项
- 失败：____ 项
- 跳过：____ 项

**发现的问题**：
1. ____________________
2. ____________________
3. ____________________

**改进建议**：
1. ____________________
2. ____________________
3. ____________________

**总体评价**：
□ 优秀 - 可以发布
□ 良好 - 小问题需修复
□ 一般 - 需要改进
□ 较差 - 需要重新开发

---

## 🎯 下一步行动

### 如果测试通过
1. ✅ 提交代码到 Git
2. ✅ 更新 README.md
3. ✅ 发布新版本
4. ✅ 通知用户更新

### 如果测试失败
1. 记录所有问题
2. 分析问题原因
3. 修复代码
4. 重新测试
5. 直到所有测试通过

---

## 📝 测试注意事项

1. **每次测试前**：
   - 备份数据库
   - 清理旧的配置文件
   - 确保环境干净

2. **测试过程中**：
   - 详细记录每一步
   - 截图保存关键界面
   - 记录所有错误信息

3. **测试完成后**：
   - 清理测试数据
   - 恢复环境
   - 整理测试报告

---

**祝测试顺利！** 🚀


