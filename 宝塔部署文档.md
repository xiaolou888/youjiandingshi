# 📦 消息通知系统 - 宝塔部署文档

本文档详细介绍如何在宝塔面板上部署消息通知系统。

## 📋 准备工作

### 1. 服务器要求

- 操作系统：Linux（推荐 CentOS 7+、Ubuntu 18.04+）
- 内存：至少 1GB
- 硬盘：至少 10GB 可用空间

### 2. 安装宝塔面板

如果还未安装宝塔面板，请先安装：

**CentOS 安装命令：**
```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh
```

**Ubuntu/Deepin 安装命令：**
```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

安装完成后，记录下面板地址、用户名和密码。

### 3. 安装必要软件

在宝塔面板中安装以下软件（软件商店）：

- ✅ **Nginx** 1.20+
- ✅ **MySQL** 5.7+ 或 MySQL 8.0
- ✅ **PM2管理器** 4.2+（用于管理Node.js应用）
- ✅ **Node.js版本管理器**（安装 Node.js 16+）

## 🚀 部署步骤

### 第一步：创建网站目录

1. 在宝塔面板，进入【网站】
2. 点击【添加站点】
3. 填写信息：
   - 域名：`notification.yourdomain.com`（或使用IP地址）
   - 根目录：`/www/wwwroot/notification`
   - PHP版本：纯静态（不需要PHP）
4. 点击【提交】

### 第二步：上传项目文件

有两种方式上传项目：

#### 方式一：使用宝塔文件管理器（简单）

1. 在本地将项目打包成 zip 文件
2. 在宝塔【文件】管理中进入 `/www/wwwroot/notification`
3. 点击【上传】，上传 zip 文件
4. 右键解压文件

#### 方式二：使用 Git（推荐）

```bash
# SSH连接到服务器
cd /www/wwwroot
git clone <your-git-repository> notification
cd notification
```

### 第三步：配置数据库

#### 1. 创建数据库

在宝塔面板【数据库】中：

1. 点击【添加数据库】
2. 数据库名：`notification_system`
3. 用户名：`notification_user`
4. 密码：自动生成（记录下来）
5. 访问权限：本地服务器
6. 点击【提交】

#### 2. 导入数据库

1. 点击刚创建的数据库右侧的【管理】
2. 进入 phpMyAdmin
3. 点击【导入】
4. 选择文件：上传 `server/config/init.sql`
5. 点击【执行】

或使用命令行：

```bash
# SSH连接到服务器
mysql -u notification_user -p notification_system < /www/wwwroot/notification/server/config/init.sql
```

### 第四步：配置后端环境

#### 1. 安装后端依赖

```bash
cd /www/wwwroot/notification/server
npm install --production
```

如果 npm 速度慢，可以使用淘宝镜像：

```bash
npm install --production --registry=https://registry.npmmirror.com
```

#### 2. 配置环境变量

编辑 `server/.env` 文件：

```bash
cd /www/wwwroot/notification/server
cp .env.example .env
nano .env  # 或使用宝塔文件管理器编辑
```

修改以下配置：

```env
# 数据库配置
DB_HOST=localhost
DB_USER=notification_user
DB_PASSWORD=刚才创建数据库时的密码
DB_NAME=notification_system
DB_PORT=3306

# 服务器配置
PORT=3000
NODE_ENV=production
```

保存并退出（nano编辑器：Ctrl+O 保存，Ctrl+X 退出）。

### 第五步：启动后端服务

使用 PM2 管理器启动 Node.js 应用：

#### 1. 在宝塔面板中配置

1. 进入【软件商店】→【PM2管理器】→【设置】
2. 点击【添加项目】
3. 填写信息：
   - **项目名称**：`notification-system`
   - **启动文件**：`/www/wwwroot/notification/server/index.js`
   - **项目路径**：`/www/wwwroot/notification/server`
   - **运行环境**：选择 Node.js 16+
4. 点击【提交】
5. 启动项目

#### 2. 或使用命令行

```bash
cd /www/wwwroot/notification/server

# 启动应用
pm2 start index.js --name notification-system

# 设置开机自启
pm2 startup
pm2 save

# 查看状态
pm2 status

# 查看日志
pm2 logs notification-system
```

### 第六步：构建前端

```bash
cd /www/wwwroot/notification/client

# 安装依赖
npm install --registry=https://registry.npmmirror.com

# 构建生产版本
npm run build
```

构建完成后，会在 `client/dist` 目录生成静态文件。

### 第七步：配置 Nginx

#### 1. 修改网站配置

在宝塔面板【网站】中，找到刚创建的网站，点击【设置】→【配置文件】，替换为以下内容：

```nginx
server {
    listen 80;
    server_name notification.yourdomain.com;  # 改成你的域名或IP
    
    # 前端静态文件
    root /www/wwwroot/notification/client/dist;
    index index.html;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;

    # API 反向代理
    location /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 前端路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 访问日志
    access_log /www/wwwroot/notification/logs/access.log;
    error_log /www/wwwroot/notification/logs/error.log;
}
```

#### 2. 创建日志目录

```bash
mkdir -p /www/wwwroot/notification/logs
chmod 755 /www/wwwroot/notification/logs
```

#### 3. 重启 Nginx

在宝塔面板【软件商店】→【Nginx】→【重启】

或使用命令：

```bash
nginx -t  # 检查配置文件
systemctl restart nginx  # 重启 Nginx
```

### 第八步：配置防火墙

在宝塔【安全】中，确保开放以下端口：

- ✅ **80** (HTTP)
- ✅ **443** (HTTPS，如果启用SSL)
- ✅ **8888** (宝塔面板)

**注意**：不要开放 3000 端口（后端端口），只允许本地访问。

### 第九步：配置 SSL（可选但推荐）

#### 1. 申请免费 SSL 证书

在宝塔面板【网站】→【设置】→【SSL】：

1. 选择【Let's Encrypt】
2. 填写邮箱
3. 点击【申请】

#### 2. 强制 HTTPS

申请成功后，勾选【强制HTTPS】。

## ✅ 验证部署

### 1. 检查后端服务

```bash
# 查看PM2状态
pm2 status

# 查看后端日志
pm2 logs notification-system

# 测试API
curl http://localhost:3000/api/health
```

应该返回：`{"status":"ok","message":"服务运行正常"}`

### 2. 访问前端

在浏览器中打开：`http://notification.yourdomain.com`

应该能看到登录界面（深色主题）。

### 3. 测试功能

1. 配置SMTP邮箱
2. 创建一个测试通知
3. 查看是否正常发送

## 🔧 常见问题

### 1. 后端服务启动失败

**查看日志：**
```bash
pm2 logs notification-system --lines 100
```

**常见原因：**
- 数据库连接失败：检查 `.env` 配置
- 端口被占用：修改 `.env` 中的 PORT
- 依赖缺失：重新运行 `npm install`

### 2. 前端访问 404

**检查：**
- Nginx 配置是否正确
- 前端是否已构建（检查 `client/dist` 目录）
- Nginx 是否已重启

### 3. API 请求失败

**检查：**
- 后端服务是否运行（`pm2 status`）
- Nginx 反向代理配置是否正确
- 防火墙是否阻止

### 4. 邮件发送失败

**检查：**
- SMTP配置是否正确
- 邮箱是否开启SMTP服务
- 是否使用授权码（QQ/163邮箱）
- 服务器是否能访问外网SMTP端口

## 📊 性能优化

### 1. 启用 Nginx 缓存

在 Nginx 配置中已包含静态资源缓存。

### 2. 配置 PM2 集群模式

```bash
pm2 start index.js --name notification-system -i max
```

### 3. 定期清理日志

添加定时任务（宝塔【计划任务】）：

```bash
# 每月1号清理30天前的日志
0 0 1 * * mysql -u notification_user -p'密码' notification_system -e "DELETE FROM send_logs WHERE sent_at < DATE_SUB(NOW(), INTERVAL 30 DAY)"
```

## 🔄 更新应用

### 1. 更新代码

```bash
cd /www/wwwroot/notification
git pull  # 如果使用Git

# 或重新上传文件
```

### 2. 更新依赖

```bash
# 更新后端
cd server
npm install

# 更新前端
cd ../client
npm install
npm run build
```

### 3. 重启服务

```bash
pm2 restart notification-system
```

## 🛡️ 安全建议

1. ✅ 使用强密码
2. ✅ 启用 SSL 证书
3. ✅ 定期备份数据库
4. ✅ 限制数据库访问权限
5. ✅ 关闭不必要的端口
6. ✅ 定期更新系统和软件

## 📞 技术支持

如遇到问题：

1. 查看本文档【常见问题】部分
2. 查看应用日志：`pm2 logs notification-system`
3. 查看 Nginx 日志：`/www/wwwroot/notification/logs/`
4. 提交 Issue 到项目仓库

---

**部署完成！** 🎉

现在你可以开始使用消息通知系统了。


